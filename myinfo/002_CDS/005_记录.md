
# 项目学习记录


### 订单

1. 订单失败原因：程序出错
2. 续约失败后如何处理：将is_valid手动更改为1

3. 订单 shop_order
4. 子订单 shop_suborder

5. 续约shop_suborder_renewal
6. 续约日志表shop_renewal_log


### 任务

1. 下任务的时候resop 在res_user_operation写入一条记录

2. 任务表，cloud_task

3. 子任务表，cloud_task_subtask

4. 任务日志表，cloud_task_error_logs表


### tasker学习记录

1. resop将任务发送到queue_operation_task_V3队列

tasker/tasker/taskercenter.py从上面的队列中取任务，并拆分主任务

流程:
process_order_task.py处理订单任务
process_operation_task.py，处理操作任务，调用process_operation_task函数，返回的是task，调用process_task_func函数拆分任务


tasker/tasker/cloud_task/operationprocessor.py中，process_operation_task函数中，参数body是字典，body={'operation_id': 1, type: 'operation'}
将操作res_user_operation中的task_status状态变成'LOCK'，获取task_type，调用save_task方法，返回task


save_task方法在tasker/tasker/cloud_task/global_utils_task.py文件中，生成cloud_task表的一条记录，生成的task状态是NEW，返回task


tasker/tasker/taskercenter.py文件中，process_task_func，判断任务是否有锁冲突，如果冲突，将任务的状态变成ERROR，没有冲突，调用split_task函数，，把任务的状态置成DOING，调用pre_produce_subtasks


tasker/takser/taskcenter.py文件中，split_task函数，根据任务流拆分主任务，调用add_subtask函数生成子任务记录


tasker/tasker/taskcenter.py文件中，pre_produce_subtasks函数中调用get_product_subtasks，获取子任务，如果子任务的状态是NEW，将任务下发到queue_subtask_V3队列


2. taskconsumer将子任务发送到queue_subtask_V3

tasker/tasker/taskconsumer.py文件中，do_prepare_subtask方法，调用process_prepare_subtask方法，


basetask.py文件中，process_prepare_subtask方法中process_action，subtask记录的状态等字段进行修改


tasker/tasker/cloud_task/basetask.py文件中process_action方法


tasker/tasker/taskconsumer.py文件中，do_prepare_subtask方法，如果subtask的状态是NEW，将subtask的状态修改成PREPARE，并调用do_subtask方法，如果不是，将任务下发到queue_taskdone_V3


tasker/tasker/taskconsumer.py文件中，调用底层，返回一个结果，再调用deal_with_result方法


tasker/tasker/taskconsumer.py文件中，deal_with_result.py方法，如果是同步的，调用finish_subtask方法，将子任务的状态变成DONE，并且将子任务发送到queue_taskdone_V3中，如果是异步的任务，将子任务的状态变成ASYNC，调用do_async_subtask方法，


tasker/tasker/consumer.py文件，deal_with_result方法更新底层，将子任务的状态变成DOING


### 问题

1. subtask的子任务的记录是在哪生成的
2. queue_taskdone_V3队列中任务处理的入口




### 计费与产品相关

* bc_billing_item_type表，计费项类型表

用量型（amount），使用多少记多少
数量型（number），
峰值型（peak），根据峰值计费

* 计费单元 bc_bill_resources_price




### 底层问题整理

* 底层方案

有几种，区别




### 底层数据库整理（coreTasker）

* api_cputypetpl（CPU类型）

字段 | 含义 | 类型 | 备注
---- | ---- | ---- | ----
name | CPU类型名 | str | 
code | 类型代码 | str | 

* workflow_task（底层主任务）

字段 | 含义 | 类型 | 备注
---- | ---- | ---- | ----
updated_at | 更新时间 | datetime | 
created_at | 创建时间 | datetime | 
target_type | 任务类型| str | action（）、app、destroy_vm、gic、gic_extension、nic（）、pipe、traffic（）、vm
task_type | 任务类型
target_obj | 
task_info | 任务信息 | 
status | 
step | 
error_msg | 错误信息 | 
celery_task_id | 
params | 任务参数 | str | 
result | 任务执行结果 | str | 
restart | 
progress |
site_id | 节点ID | str | 
site_name | 节点名 | str| 
pri | 
queue |
customer_id | 客户ID | str | 
is_valid | 是否有效 | tinyint | 
run_dev | 

* workflow_subtask（子任务表）

字段 | 含义 | 类型 | 备注
---- | ---- | ---- | ----
updated_at | 更新时间 | datetime | 
created_at | 创建时间 | datetime | 
parent_id | 主任务id | str | 
step | 
status | 
agent | 
params | 
result | 
celery_task_id | 
brother_id | 
group_id | 
result_key_id | 
is_last | 

* 

### 底层数据库（cdscore）

* auth_permission
