### 索引选择

* 原理

MySQL 在选取索引时，会参考索引的基数（Cardinality），基数是 MySQL 估算的，反映这个字段有多少种取值

基数计算：选取几个页算出取值的平均值，再乘以页数

* 强制使用索引

使用 force index 强制使用某个索引

* 重新统计索引信息

使用 analyze table 重新统计索引信息


### 索引排查

```mysql
EXPLAIN SQL语句; 
```


### 索引失效 - 表达式

* 表结构

```mysql
mysql> desc film;
+---------+-------------------+------+-----+---------+-----------------+
| Field   | Type              | Null | Key | Default | Extra           |
+---------+-------------------+------+-----+---------+-----------------+
| film_id | smallint unsigned | NO   | PRI | NULL    | auto_increment  |
+---------+-------------------+------+-----+---------+-----------------+
```

* 索引

```mysql
mysql> show index from film;
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table | Non_unique | Key_name | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| film  |          0 | PRIMARY  |            1 | film_id     | A         |        1000 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
+-------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
```

* 查询

```mysql
# 使用表达式
SELECT * FROM `film` WHERE `film_id` + 1 = 100;
```

* 分析

```mysql
mysql> explain SELECT * FROM `film` WHERE `film_id` + 1 = 100;
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
|  1 | SIMPLE      | film  | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 1000 |   100.00 | Using where |
+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+
```


### 索引失效 - 函数

* 表结构

```mysql
mysql> desc rental;
+-------------+----------+------+-----+---------+-------+
| Field       | Type     | Null | Key | Default | Extra |
+-------------+----------+------+-----+---------+-------+
| rental_date | datetime | NO   | MUL | NULL    |       |
+-------------+----------+------+-----+---------+-------+
```

* 索引

```mysql
mysql> show index from rental;
+--------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table  | Non_unique | Key_name    | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+--------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| rental |          0 | rental_date |            1 | rental_date | A         |       15815 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
+--------+------------+-------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
```

* 查询

```mysql
SELECT * FROM `rental` WHERE MONTH(`rental_date`) = 5;
```

* 分析

```mysql
mysql> explain SELECT * FROM `rental` WHERE MONTH(`rental_date`) = 5;
+----+-------------+--------+------------+------+---------------+------+---------+------+-------+----------+-------------+
| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |
+----+-------------+--------+------------+------+---------------+------+---------+------+-------+----------+-------------+
|  1 | SIMPLE      | rental | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 16005 |   100.00 | Using where |
+----+-------------+--------+------------+------+---------------+------+---------+------+-------+----------+-------------+
```


### 索引失效 - 隐式转换（如字符串列使用数字类型做查询条件）

* 查询

```mysql
# 如 f1 为 VARCHAR，下面语句索引失效
SELECT * FROM t1 WHERE f1 = 5;

# 上面的语句相当于下面语句，将 VARCHAR 先转换为 INT 类型
SELECT * FROM t1 WHERE CAST(f1 AS signed int) = 5;
```


### 索引失效 - 隐式字符编码转换

* 查询

```mysql
# t1 表字符编码格式为 utf8mb4，t2 表字符编码格式为 utf8
SELECT t2.* FROM t1, t2 WHERE t1.f1 = t2.f1 AND t1.f2 = 5;

# 上面的语句相当于下面语句
SELECT t2.* FROM t1, t2 WHERE t1.f1 = CONVERT(t2.f1 USING utf8m64) AND t1.f2 = 5;
```


### 索引失效

* IN，如果是单个条件走索引，多个条件不走索引

* NOT IN 不走索引

* 模糊匹配（%%）、正则表达式

* 联合索引没有满足最左匹配原则

* 要查询的数据比例很大时
