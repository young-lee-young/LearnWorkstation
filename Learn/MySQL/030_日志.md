# 数据库日志


### UndoLog（回滚日志）

UndoLog 是一条链表，链表头部是最新的旧记录，链表尾部最早的旧记录

存储引擎层（InnoDB）产生的逻辑日志，记录的是数据的历史版本；对于任何数据（缓存）的更新，都先写 UndoLog

* 作用

事务回滚和展示旧版本

* 为什么 UndoLog 能保证原子性

如果某条语句执行错误，需要执行回滚操作，通过 UndoLog去回滚


### RedoLog（重做日志）

WAL：Write Ahead Log（预写日志：先写日志，再写磁盘）

存储引擎层（InnoDB）物理日志，记录数据页的变化，4 个 1GB 文件

内存中的数据更新后写 RedoLog，数据被写入硬盘后删除 RedoLog

write pos：当前日志写入点

check point：擦除点，数据被更新到硬盘时删除

当 write pos 追上 check point，事务无法提交，需要等待 check point 推进


### BinLog（归档日志）

MySQL 层逻辑日志（记录数据变化，不记录物理数据页变化），记录数据库每次的数据操作，可作为数据闪回手段

* 作用

进行数据的复制和数据传送


* 格式

statement：记录 SQL 语句原文，由于主备库对于 SQL 的执行不一致，可能有数据安全风险


### 二阶段提交

获取数据 -> 判断是否在内存中（如果不在从磁盘中读取数据到内存）-> 返回数据（**引擎层**）

-> 修改行数据（**执行器层**）

-> 写 UndoLog -> 新数据更新到内存 -> 写 RedoLog 到内存，此时标记为 prepare 状态（**引擎层**）

-> 写 BinLog 到内存（**执行器层**）

-> 提交事务，处于 commit 状态（**执行器层**）


### 问题

* 为什么 RedoLog 直接写入磁盘，而数据需要先缓存在内存中，合适的时机刷入磁盘

RedoLog 为顺序读写，数据写入随机读写，因此 RedoLog 写入的很快，数据的写入很慢

* RedoLog 和 BinLog 区别

1. RedoLog 引擎层，BinLog MySQL层
2. RedoLog 是物理日志，记录的是 "在某个数据页上做了什么修改"；BinLog 是逻辑日志，记录的是语句的原始逻辑
3. RedoLog 是循环写，固定的空间会用完，BinLog 是追加写入

* 为什么用二阶段提交

如果使用多个引擎，必须使用 BinLog，如果使用 InnoDB，就要使用 RedoLog；二阶段提交是保证两份日志的一致

prepare -> BinLog -> commit

主要是用 BinLog 恢复数据

如果在 prepare 后崩溃，重启后发现没有 commit，会进行回滚；在 RedoLog 和 BinLog 不存在这个更新数据

如果在 BinLog 后崩溃，重启后发现没有 commit，会进行 commit；在 RedoLog 和 BinLog 中存在这个更新数据
