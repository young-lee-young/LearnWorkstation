# 可靠传输


### 目的

保证接收方收到的字节流和发送方发送的字节流是完全一样的



### 停止等待协议（SW）

* 实现原理

1. 每发送完一个数据帧就停止发送，等待对方确认
2. 收到确认后再发送下一数据帧
3. 每次发送完一个数据帧，将数据帧拷贝一份放入缓存，并启动重传计时器，当计时器超时还未收到确认，就重传该数据帧

* 自动重传请求ARQ（Automatic Repeat Request）

1. 重传的请求是发送方自动进行的，接收方不需要请求发送方重传某个出错数据帧

* 情况

1. 无差错情况
2. 数据帧丢失或误码：客户端超时重传
3. 确认帧丢失：客户端超时重传，服务端丢弃重复数据帧，重发确认帧
4. 确认帧迟到：客户端超时重发，服务端丢弃重复数据帧，重发确认帧，客户端收到第二次确认帧，又收到第一次确认帧，收下确认帧，不做任何操作

* 滑动窗口角度

1. 使用1bit给帧编号，0或1

* 信道利用率

Td：数据帧发送时延（取决于发送速率和帧长度）
RTT：信号往返时延（客户端于服务端距离和信号传播速度）
Ta：确认帧发送时延（取决于发送速率和帧长度）

U = Td / (Td + RTT + Ta)

1. 信道利用率低，当往返时延RTT远大于数据帧发送时延Td时，信道利用率非常低


### 后退N帧协议（GBN）

* 实现原理

1. 发送方可在未收到接收方确认帧情况下，将窗口内的数据帧全部发送出去
2. 接收方只接收窗口内序列号且无误数据帧，窗口前移一位，发送确认帧，当时多为累计确认
3. 发送发在收到确认帧时，窗口相应滑动
4. 发送窗口内的某个帧超时重传，其后续的窗口内的帧也都重传

* 窗口大小

1. 发送方窗口大小：1 < Wt < 2^n - 1，n是帧序号的比特数量，Wt > 2^n - 1会造成接收方无法分辨新、旧数据帧的问题
2. 接收方窗口大小：Wr = 1，接收方只能按序接收数据帧，无缓存，其他数据帧丢弃

* 总结

1. 累积确认
2. 重传出错帧后续所有帧
3. 接收方无缓存


### 选择重传协议（SR）

* 实现原理

	1. 发送方发送窗口内的所有数据帧，每个帧启动一个超时定时器。接收到确认帧后，将帧标记为发送成功，如果是最左数据帧，窗口向前移动
	2. 接收方接收所有接收窗口内的帧，接收一个帧缓存数据帧，并发送确认帧。如果数据帧有误或者丢失，接收方发送否认帧NAK，发送方收到NAK后，立即重发该帧
	3. 发送方只重传出错或超时数据帧

* 窗口大小

	1. 发送发窗口大小：1 < Wt <= 2 ^ (n -1)，n是帧序号的比特数量，Wt > 2 ^ (n -1)会造成接收方无法分辨新、旧数据帧的问题
	2. 接收方窗口大小：1 < Wr < Wt，Wr > Wt没有意义

* 总结
  1. 逐一确认，有否认帧
  2. 重传出错帧
  3. 接收方有缓存