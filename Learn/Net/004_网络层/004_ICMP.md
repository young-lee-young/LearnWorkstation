# ICMP（网络控制协议，Internet Control Message Protocol）


### 基础

* 作用

为了更有效的转发 IP 数据报和提高交付成功的机会，在网络层使用 ICMP

主机或路由器使用 ICMP 来发送**差错报告报文**和**询问报文**

* 封装

ICMP 报文被封装在 IP 数据报中发送


### 差错报告报文分类

* 终点不可达

当路由器或主机不能交付数据报时，向源点发送终点不可达报文

具体再根据 ICMP 代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知等13种错误

* 源点抑制

当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢

* 时间超过

当 TTL 为 0 时，路由器将 IP 数据报丢弃，并向源点发送时间超过报文

当终点在规定时间内不能收到一个数据报的全部数据报片时，就把已收到的数据全部丢弃，并向源点发送时间超过报文

* 参数问题

路由器或目的主机收到 IP 数据报后，根据其首部中的校验和字段发现报文在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文

* 改变路由（重定向）

路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可更好的路由）

* 注意⚠️

1. 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文
2. 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
3. 对具有多播地址的数据报都不发送 ICMP 差错报告报文
4. 对具有特殊地址（如 127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文


### 询问报文

* 回送请求和回答

**ICMP 回送请求报文**是由主机或路由器向一个特定目的主机发出的询问

收到此报文的主机必须给源主机或路由器发送 **ICMP 回送回答报文**

报文作用：测试目的站是否可达及了解其有关状态

* 时间戳请求和回答

**ICMP 时间戳请求报文**是请求某个主机或路由器回答当前的日期和时间

在报文中有一个 32 位的字段，其中写入的整数代表从 1900.1.1 起到当前时刻一共多少秒

报文作用：进行时钟同步和测量时间


### ping（分组网间探测，Packet Internet Groper）

* 作用

测试主机或路由器的连通性

* 使用协议

应用层直接使用网络层的 ICMP 协议（没有通过传输层的 TCP 或 UDP）

* 使用报文

使用 回送请求和回答报文


### traceroute（跟踪路由）

* 作用

测试 IP 数据报从源主机到达目的主机要经过哪些路由器

* Windows下

命令：tracert

应用层直接使用网络层 ICMP

使用回送请求和回答报文、差错报告报文

原理：

1. 源主机发送 ICMP 回送请求报文，报文被封装在 IP 数据报中，IP 数据报中首部 TTL = 1
2. 报文到达路由器后 TTL 减为 0，丢弃该数据报，并向源主机发送 ICMP 差错报告（时间超过）
3. 源主机收到数据报后，知道了第一个路由器 IP 地址
4. 源主机继续发送下一个封装有 ICMP 回送请求报文的 IP 数据报，首部中 TTL = 2
5. 数据报到达第二个路由器时 TTL 减为 0，丢弃该数据报，并向源主机发送 ICMP 差错报告（时间超过）
6. 源主机收到数据报后，知道了第二个路由器 IP 地址
7. 源主机继续发送下一个封装有 ICMP 回送请求报文的 IP 数据报，首部中 TTL = 3
8. 数据报到达目的主机后，发现其中封装的是 ICMP 回送请求报文，给源主机发送封装有 ICMP 回送请求回答报文的 IP 数据报


* Unix下

命令：traceroute

在运输层使用 UDP 协议

使用 差错报告报文
