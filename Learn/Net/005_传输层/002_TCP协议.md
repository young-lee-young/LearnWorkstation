# TCP协议（Transmission Control Protocol，传输控制协议）


### 基础

仅支持单播

最小20字节，最大60字节（可选部分最大为40字节）


### 作用

是面向连接的、可靠的、基于字节流的传输层通信协议

1. 面向连接（所谓的连接，其实是在客户端和服务端的内存里保存的一份关于对方的信息，如IP地址、端口号等）
2. 数据报文都有序号，对方收到则发送 ack 确认，未收到重传
3. 基于字节流（根据MTU大小，将应用层数据字节流分割成报文段）


### 报文头

20字节固定首部 + 40字节扩展首部

* 源端口

占 16 位

* 目的端口

占 16 位

* 序列号（seq，Sequence Number）

占 32 位，取值范围 [0, 2^32 - 1]，序列号增加到最后一个后，下一个序列号又回到 0

指出本 TCP 报文段数据载荷的**第一个字节**的序号

* 确认号（ack，Acknowledgement Number）

占 32 位，取值范围 [0, 2^32 - 1]，确认号增加到最后一个后，下一个确认号又回到 0

指出期望收到对方下一个 TCP 报文段数据载荷的第一个字节的序号，同时也是对之前收到的所有数据的确认

如确认号为 n，表明到序号 n-1 为止的所有数据都已正确接收，期望接收序号为 n 的数据

⚠️
1. ACK 标志位为 1 时，确认号字段才有效，为 0 时，确认号字段无效
2. TCP 规定，在连接建立后，所有传送的 TCP 报文段都必须把 ACK 置为 1

* 数据偏移

占 4 位

用来指出 TCP 报文段数据载荷部分的起始处距离 TCP 报文段的起始处有多远，单位为 4 字节

实际上是指出了 TCP 报文段的首部长度

⚠️
1. 首部固定长度为 20 字节，因此数据偏移字段的最小值为 0101（5）
2. 首部最大长度为 60 字节，因此数据偏移字段的最大值为 1111（15）

* 保留

占 6 位，目前置为 0

* 标志位

1. 同步标志位 SYN（Synchronize Sequence Numbers）

在 TCP 连接建立时用来同步序列号，SYN = 1 时，表示是一个请求建立连接（ACK = 0）或同意建立连接（ACK = 1）的报文

2. 确认标志位 ACK（Acknowledgement）

ACK = 1，表示是一个 TCP 确认报文段

3. 终止标志位 FIN（Finish）

用来释放 TCP 连接

4. 复位标志位 RST（Reset）

用来复位 TCP 连接；当 RST = 1时，表明 TCP 连接出现了异常，必须释放连接，然后再重新建立连接

RST = 1，还用来拒绝一个非法的报文段或拒绝打开一个 TCP 连接

5. 推送标志位 PSH（Push）

接收方收到标志位为 1 的报文段会尽快上交应用进程，而不必等到接收缓存都填满后再向上交付

6. 紧急标志位 URG（Urgent）

取值为 1 时，紧急指针字段有效，取值为 0 时，紧急指针字段无效

* 窗口大小

占 16 位

指出发送本报文段的一方的接收窗口（rwnd，Receiver Window），单位为字节

窗口值作为接收方让发送方设置其发送窗口的依据

以接收方的接收能力来控制发送方的发送能力，即流量控制

* 校验和

占 16 位

检查整个 TCP 报文段在传输过程中是否出现了误码

* 紧急指针

占 16 位

用来实现紧急操作，指明紧急数据的长度，单位为字节

当发送方有紧急数据时，可将紧急数据插队到发送缓存的最前面，并立即封装到一个 TCP 报文段中进行发送。
紧急指针会指出本报文段数据载荷部分包含了多长的紧急数据，紧急数据之后是普通数据。

接收方收到紧急标志为 1 的报文段，会按照紧急指针字段的值，从报文段数据载荷部分取出紧急数据，直接上交应用进程，不必在接收缓存中排队

* 选项

长度可变，最大 40 字节

1. 最大报文段长度（MSS，Maximum Segment Size）选项：TCP 报文段数据载荷部分最大长度
2. 窗口扩大选项：扩大窗口，提高吞吐率
3. 时间戳选项：计算往返时间 RTT；用来处理序列号超范围情况，又称为防止序号绕回（PAWS，Protect Against Wrapped Sequence Numbers）
4. 选择确认选项：实现确认选择功能

⚠️
1. 选项长度可变，需要填充，确保报文首部能被 4 整除
