# MySQL 锁机制


### 锁命令

* 加锁、释放锁

```mysql
# 显示加表锁
LOCK TABLES table_name READ/WRITE;

# 显示释放表锁
UNLOCK TABLES;
```


* 显示锁状态

```mysql
# 锁状态输出配置
SHOW VARIABLES LIKE 'innodb_status_output_locks';

# 设置
SET GLOBAL innodb_status_output_locks = 1;

# 查看当前锁请求信息
SHOW ENGINE InnoDB STATUS\G;
```


### 按粒度分类

* 全局锁

FTWRL（Flush tables with read lock），此命令使整个库处于只读状态

主要作用：保证备份的一致性；不要随意使用，一般在备库使用


* 表锁

1. 分数据锁（锁数据）

表锁是非常重的锁，在 InnoDB 中很少使用

2. 元数据锁（metadata lock，锁表的结构、字段、数据类型、索引等）

元数据：表的结构、字段、数据类型、索引等

事务访问数据时，会自动给表加 MDL 读锁；事务修改元数据时，会自动给表加 MDL 写锁


* 行锁

1. 共享锁（读锁）

在同一时间段内，多个用户（事务）可以读取同一资源，读取过程中数据不会发生任何变化

2. 排他锁（写锁）

在任何时候只能有一个用户（事务）写入资源，当进行写锁时会阻塞其他的读锁或者写锁操作


### 自增锁

1. 有自增列，添加数据时锁定，保证自增值唯一
2. 一张表同一时间只有一个自增锁
3. 自增分配后加一，即使事务回滚，子增值不会减


### 乐观锁与悲观锁

乐观锁：直接改数据，更新的时候发现数据已经改变就回滚

悲观锁：先锁数据，再更新


### 锁兼容

* 锁兼容

读读：不会有并发安全问题

读写：MVCC

写写：加锁
