### 索引下推

* 索引

```mysql
mysql> SHOW INDEX FROM inventory;

+-----------+------------+----------------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table     | Non_unique | Key_name             | Seq_in_index | Column_name  | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+-----------+------------+----------------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| inventory |          1 | idx_store_id_film_id |            1 | store_id     | A         |           2 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| inventory |          1 | idx_store_id_film_id |            2 | film_id      | A         |        1521 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
+-----------+------------+----------------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
```

* 数据示例

+----------+---------+-----------+
| store_id | film_id | inventory |
+----------+---------------------+
| 1        | 2       | 3         |
| 1        | 5       | 2         |
| 2        | 1       | 9         |
| 2        | 3       | 5         |
| 3        | 4       | 4         |
+----------+---------+-----------+

* 查询

```mysql
SELECT * FROM inventory WHERE store_id IN(1, 2) AND film_id = 3;
```

* 分析

```mysql
mysql> EXPLAIN SELECT * FROM inventory WHERE store_id IN (1, 2) AND film_id=3;

+----+-------------+-----------+------------+------+-------------------------------------+----------------+---------+-------+------+----------+-------------+
| id | select_type | table     | partitions | type | possible_keys                       | key            | key_len | ref   | rows | filtered | Extra       |
+----+-------------+-----------+------------+------+-------------------------------------+----------------+---------+-------+------+----------+-------------+
|  1 | SIMPLE      | inventory | NULL       | ref  | idx_fk_film_id,idx_store_id_film_id | idx_fk_film_id | 2       | const |    4 |    20.00 | Using where |
+----+-------------+-----------+------------+------+-------------------------------------+----------------+---------+-------+------+----------+-------------+
```

不能走索引原因：根据 store_id 走索引后，film_id 是乱序的，film_id = 3 没法走索引

在 MySQL 5.5 及之前，在查询完 store_id IN(1, 2) 走索引后，需要回表 4 次查询 film_id = 3


* 索引下推（MySQL 5.6 及之后）

在查询完 store_id IN(1, 2) 后，再过滤 film_id = 3 后，回表查询 1 次


### 松散索引扫描（Skip Scan，MySQL 8.0）

联合索引下，可以跳过左侧的索引，使用右侧索引

* 查询

```mysql
SELECT film_id FROM inventory WHERE film_id = 3;
```

* 原理

1. 先搜索 store_id = 1 的数据，查询 film_id = 3
2. 再搜索 store_id = 2 的数据，查询 film_id = 3
3. 再搜索 store_id = 3 的数据，查询 film_id = 3
