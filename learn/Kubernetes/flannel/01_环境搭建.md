### 安装

```bash
# 下载 flannel
wget https://github.com/flannel-io/flannel/releases/download/v0.24.0/flannel-v0.24.0-linux-arm64.tar.gz

# 创建文件夹
sudo mkdir /opt/flannel

# 解压
sudo tar xzvf flannel-v0.24.0-linux-arm64.tar.gz -C /opt/flannel/

# 使用 API v3 版本
export ETCDCTL_API=3

# flannel 网络配置文件，存储到 etcd 中
etcdctl put /coreos.com/network/config < flannel-config.json

# 验证数据
etcdctl get /coreos.com/network/config

# flannel 服务配置文件
sudo vim /etc/systemd/system/flanneld.service
```

* 配置文件：flannel-config.json

```json
{
    "Network": "172.20.0.0/16",
    "SubnetMin": "172.20.10.0",
    "SubnetMax": "172.20.20.0",
    "Backend": {
        "Type": "vxlan"
    }
}
```

* 服务配置文件：/etc/systemd/system/flanneld.service

```
[Unit]
Description=Flanneld
Documentation=https://github.com/coreos/flannel
After=network.target
Before=docker.service

[Service]
User=root
ExecStart=/opt/flannel/flanneld --etcd-endpoints="http://192.168.26.20:2379,http://192.168.26.21:2379,http://192.168.26.22:2379" --iface=ens160 --ip-masq
Restart=on-failure
Type=notify
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
```

* 启动服务

```bash
# 加载服务
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start flanneld.service
```


### 检查服务

```bash
# 查看所有的 key
ETCDCTL_API=3 etcdctl get /coreos.com/network --prefix --keys-only
```


### 修改 Docker 的网段

修改 Docker 的网段，这样可以通过 flannel 来管理

```bash
# 会生成 /run/docker_opts.env 文件
sudo /opt/flannel/mk-docker-opts.sh -c

# 查看文件内容
cat /run/docker_opts.env

# 修改 Docker 服务配置文件，修改以下内容
sudo vim /lib/systemd/system/docker.service
# EnvironmentFile=/run/docker_opts.env # 这一行新增
# ExecStart=/usr/bin/dockerd $DOCKER_OPTS -H fd:// --containerd=/run/containerd/containerd.sock # 这一行增加 $DOCKER_OPTS

# 重新加载服务文件
sudo systemctl daemon-reload

# 重启 Docker
sudo systemctl restart docker.service
```
