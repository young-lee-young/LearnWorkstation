# Kubernetes 搭建


### 前置工作

* 关闭交换分区

```bash
# 关闭所有交换分区
sudo swapoff -a

sudo vim /etc/fstab
```

* 关闭防火墙

```bash

```


### 初始化 master

```bash
# 生成 kubeadm 配置文件
kubeadm config print init-defaults > kubeadm-config.yaml

# 修改 kubeadm 配置文件，修改为下面的配置文件

# 初始化
sudo kubeadm init --config kubeadm-config.yaml

#  修改权限
sudo chmod 666 /etc/kubernetes/admin.conf
```

* kubeadm 配置文件：kubeadm-config.yaml

```yaml
apiVersion: kubeadm.k8s.io/v1beta3
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 0.0.0.0 # 修改
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  name: master # 修改
  taints: null
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta3
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns: {}
etcd: # 修改，使用已有的 ETCD
  external:
    endpoints:
    - http://192.168.26.20:2379
    - http://192.168.26.21:2379
    - http://192.168.26.22:2379
imageRepository: registry.k8s.io
kind: ClusterConfiguration
kubernetesVersion: 1.28.0
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.10.0.0/16 # 修改子网的网段
scheduler: {}
```

* node 加入集群

```bash
sudo kubeadm join 192.168.26.20:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:221a10ebf6bbdd8d6ff5427160b8e2a084b827b317bb6223f8e23ac1be426619
```


### 使用

```bash
export KUBECONFIG=/etc/kubernetes/admin.conf
```
