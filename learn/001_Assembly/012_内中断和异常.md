# 中断和异常



### 基础

* 中断号

| 起始 | 结束 | 个数 |        作用        |
| :--: | :--: | :--: | :----------------: |
| 0x00 | 0x07 |  8   | CPU预留，错误/异常 |
| 0x08 | 0x0f |  8   |      硬件中断      |
| 0x10 | 0x1a |  11  |      BIOS中断      |
|      |      |      |     自定义中断     |



* 中断向量表（IVT，interrupt vector table）

地址：0x000 - 0x3FF，大小为 1KB



* 中断向量

每个中断向量大小为 4 B，一共 256 个中断，4B * 256 = 1024B = 1KB，从 0x00号中断顺序排列

前两个字节为偏移地址，后两个字节为段地址



* 中断处理程序流程

1. 保存现场，保存寄存器值（FLAGS、CS、IP）
2. 参数传递
3. IRET（interrupt return）返回，弹栈



### 内中断（内部软件中断）

```assembly
; 注册 0x80 中断
mov word [0x80 * 4], interrupt_handle ; 注册中断向量的偏移地址
mov word [0x80 * 4 + 2], 0 ; 注册中断向量的段地址

; 触发中断
int 0x80

interrupt_handle:
		...
		iret ; 中断返回
```



### 外中断（外部硬件中断）

* 引脚

INTR：可屏蔽中断，CPU根据 IF（interrupt flag） 标志决定是否处理该中断

NMI：不可屏蔽中断（比较紧急的中断，CPU需要优先处理）