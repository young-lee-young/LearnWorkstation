### 安装

```bash
# 下载
wget https://github.com/kata-containers/kata-containers/releases/download/3.2.0/kata-static-3.2.0-amd64.tar.xz

# 解压
tar xvf kata-static-3.2.0-amd64.tar.xz -C /

# 软连接
sudo ln -s /opt/kata/bin/containerd-shim-kata-v2 /usr/local/bin/containerd-shim-kata-v2
sudo ln -s /opt/kata/bin/kata-collect-data.sh /usr/local/bin/kata-collect-data.sh
sudo ln -s /opt/kata/bin/kata-runtime /usr/local/bin/kata-runtime
sudo ln -s /opt/kata/bin/kata-monitor /usr/local/bin/kata-monitor

# 检查
kata-runtime --version
kata-runtime kata-check
```

* 修改配置文件

```toml
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  ...
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.kata]
  runtime_type = "io.containerd.kata.v2"
  privileged_without_host_devices = false
```

* 验证

```bash
# 拉取镜像
sudo ctr image pull docker.io/library/busybox:latest

# 使用 runc 启动容器
sudo ctr run --rm -t docker.io/library/busybox:latest hello uname -r

# 使用 kata 启动容器
sudo ctr run --runtime "io.containerd.kata.v2" --rm -t docker.io/library/busybox:latest hello uname -r

# 启动容器不退出
sudo ctr run --runtime "io.containerd.kata.v2" --rm -t docker.io/library/busybox:latest hello sh
```


### kubernetes 使用 kata

* 定义新运行时：runtime-kata.yaml

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: kata
handler: kata
```

```bash
kubectl apply -f runtime-kata.yaml
```

* 创建 Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox
spec:
  runtimeClassName: kata
  containers:
  - name: busybox
    image: docker.io/library/busybox:latest
```
