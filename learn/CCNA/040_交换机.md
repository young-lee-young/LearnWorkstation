# 交换机


### 交换机分层结构

1. 接入层：用户接入，接入安全，访问控制
2. 汇聚层：流量汇聚，链路冗余，设备冗余，路由选择
3. 核心层：高速转发，服务器接入，路由选择
4. 出口层：广域网接入，出口策略，带宽控制


### 交换机功能

1. 地址学习
2. 数据转发
3. 避免环路


### 接口类型

1. Access：连接终端、服务器
2. Trunk：承载多 VLAN 数据，Trunk 两端交换机需采用相同的干道协议，一般在交换机之间或交换机与路由器之间
3. Hybrid：


Access接口接收数据帧规则：如果数据帧不带TAG，交换机接受并打TAG；如果数据帧带TAG，如果TAG中的vlan_id和接口设置的vlan_id相同，接受数据帧，不同，丢弃数据帧
Access接口发送数据帧规则：将TAG从数据帧中删除，将原始数据帧发送出去

Trunk接口接收数据帧规则：如果数据帧不带TAG，交换机接受并打TAG，如果TAG vlan_id在接受列表中，接收数据帧，否则丢弃；如果数据帧带TAG，检查TAG中的vlan_id在是否在接受列表中，如果在，接收数据帧，否则丢弃
Trunk接口发送数据帧规则：如果TAG中vlan_id与接口vlan_id相同，将TAG去掉，发送出去；如果不相同，直接将带有TAG的数据帧发送出去


### 交换机学习和转发帧过程（泛洪不向自己转发，转发的是普通数据帧，非广播帧）（广播包、组播报、未知单播包）

1. 交换机根据收到数据帧中的源MAC地址建立该地址同交换机端口的映射，并将其写入MAC地址表中

2. 交换机根据收到数据帧中的目的MAC地址同已建立的MAC地址表进行比较，以决定由哪个端口进行转发

3. 如数据帧中的目的MAC地址不在MAC地址表中，则向所有端口转发，这一过程称为泛洪（flood）

4. 广播帧和组播帧向所有的端口转发


### 广播和泛洪区别

广播是PC端行为

泛洪是交换机行为


### 交换机

* 查看MAC地址表

```bash
# 特权模式

show mac-address-table
```


### 交换机端口安全

* 控制计算机数量

```bash
# 全局模式

interface ethernet 1/0

# 说明是接入计算机接口
switchport mode access

# 启用安全
switchport port-security

# 违反安全shutdown掉接口
switchport port-security violation shutdown

# 接入两个计算机
switchport port-security maximum 2
```


* 绑定MAC地址

```bash
interface range ethernet 0/1 - 4

switchport mode access

switchport port-security

switchport port-security violation shutdown

# 保存现在的各个端口连接的MAC地址
switchport port-security mac-address sticky
```


### 生成树协议（Spanning Tree Protocol）

* 交换机环路带来的问题

1. 广播风暴：大量消耗网络资源，使得网络无法正常转发其他数据帧
2. 主机收到重复广播帧：大量消耗主机资源
3. 交换机**帧交换表**震荡


疑问⚠️
广播风暴：为什么不用交换机发送过这个广播端口就不再发送这个广播（答案：并不能判断是否是同一个广播包）


* 生成树作用

可以增加冗余链路来提高网络可靠性的同时又避免网络环路带来的各种问题


* 生成树算法

1. 确定根交换机（选优先级小的，优先级相同选择MAC地址小的）
2. 选择根端口（连接到根交换机的为根端口）
3. 每根网线选择一个指定端口，另一个端口自动成为非指定端口

根交换机所有端口都是指定端口，其他交换机与根交换机相连的端口是根端口


* 查看交换机端口

```bash
# 特权模式

show spanning-tree
```


* 修改交换机优先级，数字越小优先级越高

```bash
# 全局模式

spanning-tree vlan 1 priority 4096
```


* 关闭生成树协议

```bash
no spanning-tree vlan 1
```
