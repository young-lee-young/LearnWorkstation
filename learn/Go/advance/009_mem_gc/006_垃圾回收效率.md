### GC 触发时机

* 系统定时触发

sysmon 定时检查（Go runtime p0 协程循环检查）：2 分钟内没有 GC，会触发 GC

```go
// runtime/proc.go
package runtime

// forcegcperiod is the maximum time in nanoseconds between garbage
// collections. If we go this long without a garbage collection, one
// is forced to run.
//
// This is a variable for testing purposes. It normally doesn't change.
var forcegcperiod int64 = 2 * 60 * 1e9
```


* 用户显示触发

```go
package main

import "runtime"

func main() {
	runtime.GC()
}
```


* 申请内存时触发

```go
// runtime/malloc.go/mallocgc
package runtime

func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
    if shouldhelpgc {
        if t := (gcTrigger{kind: gcTriggerHeap}); t.test() {
        	// 垃圾回收
            gcStart(t)
        }
    }
}
```


### GC 优化

* 尽量少在堆上产生垃圾

1. 内存池化

2. 减少逃逸

3. 使用空结构体


### GC 分析工具

```bash
go tool pprof

go tool trace

go build -gcflags="-m"

export GODEBUG="gctrace=1"
```
