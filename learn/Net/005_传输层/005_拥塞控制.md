# 拥塞控制


### 网络拥塞

在某段时间内，若网络中某一资源（如链路带宽、交换节点中的缓存和处理机等）的需求超过了该资源所能提供的可用部分，网络性能就要变坏

如果出现拥塞不进行控制，整个网络的吞吐量将随输入负荷的增大而下降


### 拥塞窗口（cwnd，Congestion Window）

* 拥塞窗口维护原则

只要网络没有出现拥塞，拥塞窗口就增大一些；只要出现网络拥塞，拥塞窗口就减小一些

* 拥塞判断依据：没有按时收到应当到达的确认报文（即发生超时重传）


### 拥塞控制方法

* 假定条件

1. 数据单方向传送，而另一个方向只传送确认
2. 接收方总是有足够大的缓存空间，因而发送方发送窗口的大小由网络的拥塞程度控制
3. 以MSS（Maximum Segment Size）的个数为讨论问题的单位，而不是以字节为单位


### 慢开始（slow start）

维护一个慢开始阈值（ssthresh，Slow Start Threshold）状态变量

当 cwnd < ssthresh 时，使用慢开始算法
当 cwnd > ssthresh 时，停止使用慢开始算法而改用拥塞避免算法
当 cwnd = ssthresh 时，既可使用慢开始算法也可以使用拥塞避免算法

发送方每收到一个对新报文段的确认时，就把拥塞窗口加1，呈指数增长

* 慢开始算法过程

假设 ssthresh = 16，起始 cwnd = 1

第一轮
1. 发送方发送窗口为 1，发送 0 号 1个 TCP 数据报文段
2. 发送方收到确认报文段，将拥塞窗口增大 1，变为 2

第二轮
1. 发送方发送窗口为 2，发送 1-2 号 2个 TCP 数据报文段
2. 发送方收到确认报文段，将拥塞窗口增大 2，变为 4

第三轮
1. 发送方发送窗口为 4，发送 3-6 号 4个 TCP 数据报文段
2. 发送方收到确认报文段，将拥塞窗口增大 4，变为 8

第四轮
1. 发送方发送窗口为 8，发送 7-14 号 8个 TCP 数据报文段
2. 发送发收到确认报文段，将拥塞窗口增大 8，变为 16

到达慢开始阈值后，改为拥塞避免算法


### 拥塞避免（congestion avoidance）

拥塞窗口每次增加 1，呈线性增长

* 步骤

如果发送方未收到确认报文段，会导致发送发对丢失报文段**超时重传**，发送方判断网络可能发生拥塞，进行以下工作

1. 将 ssthresh 值更新为发生拥塞时 cwnd 的一半
2. 将 cwnd 值减少为1，并重新开始慢开始算法


### 快重传（fast retransmit）

* 定义

快重传：使发送方**尽快进行重传**，而不是等超时重传计时器超时再重传

* 要求

1. 接收方不要等待自己发送数据时才进行捎带确认，而是要**立即发送确认**
2. 即使收到了失序的报文段也要立即发出对已收到报文段的**重复确认**
3. 发送方一旦收到**3个连续的重复确认**，就将响应的报文段**立即重传**，而不是等该报文段的超时重传计时器超时再重传

* 作用

有时，个别报文段会在网络中丢失，但实际上网络并未发生拥塞；将导致发送方超时重传，并误认为网络发生了拥塞

采用快重传算法可以让发送方尽早知道发生了个别报文段的丢失；对于个别丢失的报文段，发送方不会出现超时重传，也就不会误认为出现了拥塞（降低拥塞窗口 cwnd 为1），

快重传可以使整个网络的吞吐量提高约20%


### 快恢复（fast recovery）

发送方一旦收到**3个重复确认**，就知道现在只是丢失了个别报文段。于是不启动慢开始算法，而是执行快恢复算法

* 步骤

1. 发送方将慢开始阈值（ssthresh）和拥塞窗口（cwnd）值调整为当前窗口的一半（有的版本会 cwnd = ssthresh + 3），开始执行拥塞避免算法
