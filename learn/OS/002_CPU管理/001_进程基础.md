# 进程


### 进程基础

* 进程

进程是对运行时程序的封装，是系统资源调度和分配的基本单位

进程 = PCB（灵魂） + 程序（躯体）+ 寄存器

程序包括：**代码、数据、堆、栈**


* 进程上下文

上下文：进程的物理实体（代码和数据等，即地址空间）+ 支持进程运行的环境（PCB、内核栈、寄存器）

用户级上下文：程序块、数据块、运行时堆和栈（地址空间）

系统级上下文：进程控制信息、系统内核栈

寄存器上下文（硬件上下文）：寄存器


### 进程切换

* 进程切换时机

下降进程自身切换（主动交出 CPU）

外界强制下降进程（时间片用完）


* 上下文切换

将**寄存器上下文**保存到**内核栈中**，PCB 中有指针指向该内核栈地址


* 进程切换

进程切换：页表 + 寄存器（PC） + 栈（SP），将信息保存到内核栈

首先将用户栈指针 SP 保存到内核栈


* 如何找到内核栈

PCB 中有指向本进程**内核栈的指针**


### 进程控制块 PCB（Process Control Block）

* 作用

用于描述进程，PCB 本身在**内核态**


* 数据结构

PCB 有字段指向地址空间和内核栈

```c
struct task_struct {
    pid     // 进程 ID，/proc/sys/kernel/pid_max
    ...
    *mm     // 进程地址空间（3G 虚拟内存）
    *fs     // 文件系统资源
    *files  // 文件资源
    *signal
    
    stack   // 进程内核栈
}
```


### 问题

* 取址执行，如果遇到 IO，CPU 会等待，CPU 利用率太低

CPU 交替执行多个程序，即并发
