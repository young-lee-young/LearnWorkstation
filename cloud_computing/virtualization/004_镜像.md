# 镜像配置


### raw VS qcow2

* raw

裸格式，直接作为一个块设备给虚拟机使用，创建就需要指定存储容量，占用全部容量

优点：性能好

缺点：不支持动态扩容，不支持快照


* qcow2（quick copy on write 2）

KVM 支持的磁盘镜像格式，开始只占少许容量

优点：支持动态扩容，支持压缩，支持 AES 加密，支持快照，性能较好


### 创建镜像

```bash
qemu-img create -f qcow2 -o size=20G $image_name.qcow2
```


### 查看镜像信息

```bash
qemu-img info $image_name.qcow2
```


### 镜像转换

```bash
qemu-img convert -O qcow2 $image_name.raw $image_name.qcow2

qemu-img convert -O raw $image_name.qcow2 $image_name.raw
```


### 打包系统文件目录

```bash
tar pczvf os.tgz --exclude=/proc/* --exclude=/lost+found --exclude=/mnt/* --exclude=/sys/* --exclude=/dev/pts/* --exclude=/dev/shm/* --exclude=/var/log/* --exclude=/var/cache/* --exclude=/var/crash/* --exclude=/tmp/* --exclude=/swapfile --exclude=/home/* --exclude=/data/* /
```


### 镜像去除空洞

```bash
# 安装工具
sudo apt-get install libguestfs-tools

# 清理镜像
sudo virt-sysprep -d $host_name

# 压缩镜像
sudo virt-sparsify --compress $old_image $new_image
```


### 磁盘扩容、缩容

* 扩大镜像文件

```bash
# 扩容
sudo qemu-img resize $image_file +30G

# 缩容
sudo qemu-img resize --shrink $image_file -20G
```

* 系统内扩容文件系统

```bash
# 查看当前的硬盘信息
sudo fdisk -l

# 修复 GPT PMBR size mismatch 错误
sudo parted -l # 执行命令选 fix

# /dev/vda3 分区扩容
sudo growpart /dev/vda 3

# 查看物理卷组：volume group
sudo vgdisplay

# 查看物理卷：physical volume
sudo pvdisplay

# 扩容物理卷
sudo pvresize /dev/vda3 48.2G

# 扩容逻辑卷
sudo lvextend -L +38.22G /dev/mapper/ubuntu--vg-ubuntu--lv

# 扩容文件系统，resize2fs 扩容 ext2、ext3、ext4 文件系统
sudo resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv
# xfs_growfs 扩容 xfs 文件系统
# xfs_growfs 逻辑设备
sudo xfs_growfs /dev/mappper/ubuntu--vg-ubuntu--lv
```
